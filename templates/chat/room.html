{% extends "base.html" %}

{% block title %}Chat Negosiasi - {{ product.title }} - BarterHub{% endblock %}

{% block content %}
<!-- Product Quick View Header -->
<div class="chat-product-header bg-gradient-primary text-white p-3">
    <div class="container-fluid">
        <div class="row align-items-center">
            <div class="col-auto">
                {% set main_image = product.get_main_image() %}
                <img src="{{ url_for('static', filename='uploads/products/' + main_image) if main_image else 'https://via.placeholder.com/80x80?text=No+Image' }}" 
                     class="rounded-3" style="width: 60px; height: 60px; object-fit: cover;" alt="{{ product.title }}">
            </div>
            <div class="col">
                <h5 class="mb-1 text-white">{{ product.title }}</h5>
                <p class="mb-0 text-white-50">{{ product.owner.full_name }} â€¢ {{ product.total_points }} Poin</p>
                <small class="text-white-75">Ingin ditukar: {{ product.desired_items[:50] }}...</small>
            </div>
            <div class="col-auto">
                <div class="btn-group" role="group">
                    <button class="btn btn-outline-light btn-sm" id="quickAddBtn" title="Tambah Produk Cepat">
                        <i class="fas fa-plus-circle"></i>
                    </button>
                    <a href="{{ url_for('products.detail', id=product.id) }}" class="btn btn-outline-light btn-sm" title="Detail Produk">
                        <i class="fas fa-info-circle"></i>
                    </a>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Main Chat Interface - Full Screen -->
<div class="chat-interface-fullscreen" id="mainChatInterface">
    <div class="container-fluid h-100">
        <div class="row h-100">
            <!-- Chat Messages Area -->
            <div class="col-lg-8 col-md-12 h-100">
                <div class="chat-messages-area h-100 d-flex flex-column">
                    <!-- Messages Container -->
                    <div class="messages-container flex-grow-1 overflow-auto p-3" id="messagesContainer" style="height: calc(100vh - 200px);">
                        <!-- Welcome Message -->
                        <div class="welcome-message mb-4">
                            <div class="card border-primary bg-primary-subtle">
                                <div class="card-body text-center py-3">
                                    <div class="d-flex align-items-center justify-content-center mb-2">
                                        <div class="avatar-group me-3">
                                            <div class="avatar bg-success text-white rounded-circle d-flex align-items-center justify-content-center" style="width: 40px; height: 40px;">
                                                <i class="fas fa-user"></i>
                                            </div>
                                            <div class="avatar bg-primary text-white rounded-circle d-flex align-items-center justify-content-center ms-2" style="width: 40px; height: 40px;">
                                                <i class="fas fa-user"></i>
                                            </div>
                                        </div>
                                        <div>
                                            <h6 class="mb-1">Ruang Negosiasi Barter</h6>
                                            <small class="text-muted">Mulai tawar-menawar untuk {{ product.title }}</small>
                                        </div>
                                    </div>
                                    <div class="d-flex justify-content-center gap-2">
                                        <button class="btn btn-sm btn-success" onclick="sendQuickMessage('Halo! Saya tertarik dengan produk ini')">
                                            <i class="fas fa-wave-square me-1"></i>Sapa
                                        </button>
                                        <button class="btn btn-sm btn-warning" onclick="toggleNegotiationPanel()">
                                            <i class="fas fa-handshake me-1"></i>Tawar
                                        </button>
                                        <button class="btn btn-sm btn-info" id="quickAddBtn">
                                            <i class="fas fa-plus me-1"></i>Tambah Produk
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>

            {% if messages %}
                {% for message in messages %}
                <div class="message-item mb-2" data-message-id="{{ message.id }}">
                    {% if message.message_type == 'text' %}
                        <!-- Text Message -->
                        <div class="d-flex {% if message.sender_id == current_user.id %}justify-content-end{% endif %}">
                            <div class="message-bubble {% if message.sender_id == current_user.id %}bg-primary text-white{% else %}bg-light text-dark{% endif %} rounded-3 p-2" style="max-width: 85%;">
                                <div class="message-header mb-1">
                                    <small class="{% if message.sender_id == current_user.id %}text-white-50{% else %}text-muted{% endif %}">
                                        {{ message.sender.full_name[:10] }}{% if message.sender.full_name|length > 10 %}...{% endif %}
                                        <span class="ms-1">{{ message.created_at.strftime('%H:%M') }}</span>
                                    </small>
                                </div>
                                <div class="message-content" style="font-size: 0.9rem;">{{ message.message }}</div>
                            </div>
                        </div>

                    {% elif message.message_type == 'offer' %}
                        <!-- Offer Message - Compact -->
                        <div class="negotiation-message mb-2">
                            <div class="card border-warning bg-warning-subtle">
                                <div class="card-header bg-warning text-dark py-1">
                                    <small><i class="fas fa-handshake me-1"></i>Penawaran dari {{ message.sender.full_name[:10] }}</small>
                                </div>
                                <div class="card-body p-2">
                                    <p class="mb-2 small">{{ message.message }}</p>
                                    {% if message.sender_id != current_user.id %}
                                    <div class="offer-actions d-flex gap-1">
                                        <button class="btn btn-success btn-sm" onclick="acceptOffer({{ message.id }})">
                                            <i class="fas fa-check"></i>
                                        </button>
                                        <button class="btn btn-outline-danger btn-sm" onclick="declineOffer({{ message.id }})">
                                            <i class="fas fa-times"></i>
                                        </button>
                                    </div>
                                    {% endif %}
                                </div>
                            </div>
                        </div>

                    {% elif message.message_type == 'system' %}
                            <!-- System Message -->
                        <div class="system-message mb-3">
                            <div class="alert alert-secondary border-0 text-center py-2">
                                <small><i class="fas fa-robot me-1"></i>{{ message.message }}</small>
                            </div>
                        </div>
                    {% endif %}
                </div>
                {% endfor %}
            {% else %}
                <div class="text-center text-muted py-5">
                    <i class="fas fa-comments fs-1 mb-3 opacity-50"></i>
                    <p>Belum ada percakapan. Mulai chat sekarang!</p>
                </div>
            {% endif %}
                    </div>
                    
                    <!-- Message Input Bar -->
                    <div class="message-input-bar border-top bg-white p-3">
                        <form method="POST" class="d-flex gap-2" id="messageForm">
                            {{ form.hidden_tag() }}
                            <div class="flex-grow-1">
                                {{ form.message(class="form-control", placeholder="Tulis pesan negosiasi...", rows="1", style="resize: none; border-radius: 25px;", onkeydown="handleEnterKey(event)") }}
                            </div>
                            <div class="d-flex gap-1">
                                <button type="button" class="btn btn-outline-warning rounded-pill" onclick="toggleNegotiationPanel()" title="Buat Penawaran">
                                    <i class="fas fa-handshake"></i>
                                </button>
                                <button type="button" class="btn btn-outline-success rounded-pill" id="quickAddBtn" title="Tambah Produk Cepat">
                                    <i class="fas fa-plus-circle"></i>
                                </button>
                                <button type="submit" class="btn btn-primary rounded-pill px-3" title="Kirim Pesan">
                                    <i class="fas fa-paper-plane"></i>
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
            
            <!-- Sidebar - Quick Actions -->
            <div class="col-lg-4 col-md-12">
                <div class="quick-actions-sidebar h-100 p-3 bg-light border-start">
                    <!-- User Info -->
                    <div class="user-info mb-4">
                        <div class="card border-0 bg-white shadow-sm">
                            <div class="card-body text-center p-3">
                                <div class="avatar bg-primary text-white rounded-circle mx-auto mb-2 d-flex align-items-center justify-content-center" style="width: 50px; height: 50px;">
                                    <i class="fas fa-user fs-5"></i>
                                </div>
                                <h6 class="mb-1">
                                    {% if current_user.id == chat_room.user1_id %}
                                        {{ chat_room.user2.full_name }}
                                    {% else %}
                                        {{ chat_room.user1.full_name }}
                                    {% endif %}
                                </h6>
                                <small class="text-muted">Partner Barter</small>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Quick Actions -->
                    <div class="quick-actions mb-4">
                        <h6 class="mb-3 text-muted">AKSI CEPAT</h6>
                        <div class="d-grid gap-2">
                            <button class="btn btn-warning" onclick="toggleNegotiationPanel()">
                                <i class="fas fa-handshake me-2"></i>Buat Penawaran Barter
                            </button>
                            <button class="btn btn-success" id="quickAddProductBtn">
                                <i class="fas fa-plus-circle me-2"></i>Tambah Produk Cepat
                            </button>
                            <button class="btn btn-outline-primary" onclick="sendQuickMessage('Apakah barang masih tersedia?')">
                                <i class="fas fa-question-circle me-2"></i>Tanya Ketersediaan
                            </button>
                            <button class="btn btn-outline-info" onclick="sendQuickMessage('Bisakah kirim foto lebih detail?')">
                                <i class="fas fa-camera me-2"></i>Minta Foto Detail
                            </button>
                        </div>
                    </div>
                    
                    <!-- Product Summary -->
                    <div class="product-summary">
                        <h6 class="mb-3 text-muted">PRODUK YANG DIBAHAS</h6>
                        <div class="card border-0 bg-white shadow-sm">
                            <div class="card-body p-3">
                                <div class="d-flex">
                                    <img src="{{ url_for('static', filename='uploads/products/' + product.get_main_image()) if product.get_main_image() else 'https://via.placeholder.com/60x60?text=No+Image' }}" 
                                         class="rounded me-3" style="width: 60px; height: 60px; object-fit: cover;" alt="{{ product.title }}">
                                    <div class="flex-grow-1">
                                        <h6 class="mb-1">{{ product.title }}</h6>
                                        <div class="d-flex justify-content-between align-items-center">
                                            <span class="badge bg-primary">{{ product.total_points }} Poin</span>
                                            <small class="text-muted">{{ product.condition }}</small>
                                        </div>
                                        <small class="text-success mt-1 d-block">
                                            <strong>Ingin:</strong> {{ product.desired_items[:30] }}...
                                        </small>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Quick Product Addition Modal -->
<div class="modal fade" id="quickProductModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header bg-success text-white">
                <h5 class="modal-title">
                    <i class="fas fa-plus-circle me-2"></i>Tambah Produk Cepat untuk Barter
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="alert alert-info">
                    <i class="fas fa-info-circle me-2"></i>
                    <strong>Ingat sesuatu yang diinginkan partner?</strong> Tambah produk dengan cepat untuk menawarkan dalam negosiasi!
                </div>
                <form id="quickProductForm" enctype="multipart/form-data">
                    <div class="row g-3">
                        <div class="col-md-8">
                            <label class="form-label">Nama Produk *</label>
                            <input type="text" class="form-control" name="title" placeholder="Contoh: iPhone 13 Pro Max 256GB" required>
                        </div>
                        <div class="col-md-4">
                            <label class="form-label">Kategori *</label>
                            <select class="form-select" name="category_id" required>
                                <option value="">Pilih Kategori</option>
                                <!-- Will be populated by JavaScript -->
                            </select>
                        </div>
                        <div class="col-md-8">
                            <label class="form-label">Deskripsi Singkat *</label>
                            <textarea class="form-control" name="description" rows="2" placeholder="Kondisi baik, lengkap dengan box dan charger..." required></textarea>
                        </div>
                        <div class="col-md-4">
                            <label class="form-label">Kondisi *</label>
                            <select class="form-select" name="condition" required>
                                <option value="">Pilih Kondisi</option>
                                <option value="New">Baru</option>
                                <option value="Like New">Seperti Baru</option>
                                <option value="Good">Baik</option>
                                <option value="Fair">Cukup</option>
                            </select>
                        </div>
                        <div class="col-12">
                            <label class="form-label">Ingin Ditukar Dengan *</label>
                            <textarea class="form-control" name="desired_items" rows="2" placeholder="Laptop gaming, sepeda motor, atau cash + produk elektronik lainnya" required></textarea>
                        </div>
                        <div class="col-12">
                            <label class="form-label">Foto Produk</label>
                            <input type="file" class="form-control" name="images" accept="image/*">
                            <div class="form-text">Upload foto untuk mempercepat negosiasi</div>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Batal</button>
                <button type="button" class="btn btn-success" id="saveQuickProduct">
                    <i class="fas fa-save me-1"></i>Simpan & Tawarkan
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Negotiation Panel Modal - Enhanced -->
<div class="modal fade" id="negotiationModal" tabindex="-1">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header bg-warning text-dark">
                <h5 class="modal-title">
                    <i class="fas fa-handshake me-2"></i>Buat Penawaran Negosiasi
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="negotiationForm">
                    <div class="row g-4">
                        <!-- Offering Section -->
                        <div class="col-md-6">
                            <h6 class="text-success mb-3">
                                <i class="fas fa-gift me-2"></i>Yang Anda Tawarkan
                            </h6>
                            <div class="offer-products-list" id="offerProductsList">
                                <!-- Dynamic content will be loaded here -->
                            </div>
                            <button type="button" class="btn btn-outline-success btn-sm" onclick="addOfferProduct()">
                                <i class="fas fa-plus me-1"></i>Tambah Produk
                            </button>
                        </div>

                        <!-- Requesting Section -->
                        <div class="col-md-6">
                            <h6 class="text-info mb-3">
                                <i class="fas fa-shopping-cart me-2"></i>Yang Anda Minta
                            </h6>
                            <div class="request-products-list" id="requestProductsList">
                                <!-- Dynamic content will be loaded here -->
                            </div>
                            <button type="button" class="btn btn-outline-info btn-sm" onclick="addRequestProduct()">
                                <i class="fas fa-plus me-1"></i>Tambah Produk
                            </button>
                        </div>
                    </div>

                    <div class="mt-4">
                        <label class="form-label">Pesan Negosiasi</label>
                        <textarea class="form-control" id="negotiationMessage" rows="3" 
                                  placeholder="Tulis pesan untuk melengkapi penawaran Anda..."></textarea>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Batal</button>
                <button type="button" class="btn btn-warning" onclick="submitNegotiation()">
                    <i class="fas fa-handshake me-1"></i>Kirim Penawaran
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
// Enhanced Chat Interface Functionality
let quickProductModal = null;
let negotiationModal = null;
let messageContainer = null;

// Initialize enhanced chat interface
document.addEventListener('DOMContentLoaded', function() {
    // Initialize elements
    quickProductModal = new bootstrap.Modal(document.getElementById('quickProductModal'));
    negotiationModal = new bootstrap.Modal(document.getElementById('negotiationModal'));
    messageContainer = document.getElementById('messagesContainer');
    
    // Auto-scroll to bottom
    scrollToBottom();
    
    // Initialize quick product form
    initializeQuickProductForm();
    
    // Initialize event listeners
    initializeEventListeners();
    
    // Load categories for quick product form
    loadCategories();
    
    // Auto-refresh messages every 10 seconds
    setInterval(function() {
        if (document.visibilityState === 'visible') {
            refreshMessages();
        }
    }, 10000);
});

function initializeEventListeners() {
    // Quick add product buttons
    const quickAddBtns = document.querySelectorAll('#quickAddBtn, #quickAddProductBtn');
    quickAddBtns.forEach(btn => {
        btn.addEventListener('click', function() {
            quickProductModal.show();
        });
    });
    
    // Save quick product
    document.getElementById('saveQuickProduct').addEventListener('click', function() {
        submitQuickProduct();
    });
    
    // Message form submission
    const messageForm = document.getElementById('messageForm');
    if (messageForm) {
        messageForm.addEventListener('submit', function(e) {
            e.preventDefault();
            submitMessage();
        });
    }
}

// Handle Enter key for message sending
function handleEnterKey(event) {
    if (event.key === 'Enter' && !event.shiftKey) {
        event.preventDefault();
        const form = document.getElementById('messageForm');
        if (form) {
            const submitEvent = new Event('submit');
            form.dispatchEvent(submitEvent);
        }
    }
}

function scrollToBottom() {
    if (messageContainer) {
        setTimeout(() => {
            messageContainer.scrollTop = messageContainer.scrollHeight;
        }, 100);
    }
}

function submitMessage() {
    const form = document.getElementById('messageForm');
    const messageInput = form.querySelector('textarea[name="message"]');
    
    if (messageInput && messageInput.value.trim()) {
        const formData = new FormData(form);
        
        fetch(window.location.pathname, {
            method: 'POST',
            body: formData,
            headers: {
                'X-Requested-With': 'XMLHttpRequest'
            }
        })
        .then(response => {
            if (response.ok) {
                messageInput.value = '';
                // Add message to UI immediately for better UX
                setTimeout(() => {
                    location.reload();
                }, 300);
            }
        })
        .catch(error => {
            console.error('Error sending message:', error);
            alert('Gagal mengirim pesan. Coba lagi.');
        });
    }
}

function loadCategories() {
    fetch('/api/categories')
        .then(response => response.json())
        .then(data => {
            const categorySelect = document.querySelector('#quickProductForm select[name="category_id"]');
            if (categorySelect && data.categories) {
                categorySelect.innerHTML = '<option value="">Pilih Kategori</option>';
                data.categories.forEach(category => {
                    const option = document.createElement('option');
                    option.value = category.id;
                    option.textContent = category.name;
                    categorySelect.appendChild(option);
                });
            }
        })
        .catch(error => {
            console.error('Error loading categories:', error);
        });
}

function submitQuickProduct() {
    const form = document.getElementById('quickProductForm');
    const formData = new FormData(form);
    const submitBtn = document.getElementById('saveQuickProduct');
    
    // Validate required fields
    const required = form.querySelectorAll('[required]');
    let isValid = true;
    required.forEach(field => {
        if (!field.value.trim()) {
            field.classList.add('is-invalid');
            isValid = false;
        } else {
            field.classList.remove('is-invalid');
        }
    });
    
    if (!isValid) {
        alert('Mohon lengkapi semua field yang wajib diisi!');
        return;
    }
    
    // Show loading
    submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>Menyimpan...';
    submitBtn.disabled = true;
    
    fetch('/products/quick-add', {
        method: 'POST',
        body: formData,
        headers: {
            'X-Requested-With': 'XMLHttpRequest'
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert('Produk berhasil ditambahkan! Sekarang Anda bisa menawarkannya.');
            quickProductModal.hide();
            form.reset();
            // Refresh page to show new product in offers
            setTimeout(() => {
                location.reload();
            }, 1000);
        } else {
            alert('Error: ' + (data.error || 'Gagal menambah produk'));
        }
    })
    .catch(error => {
        console.error('Error adding product:', error);
        alert('Terjadi kesalahan. Coba lagi.');
    })
    .finally(() => {
        submitBtn.innerHTML = '<i class="fas fa-save me-1"></i>Simpan & Tawarkan';
        submitBtn.disabled = false;
    });
}

function refreshMessages() {
    fetch(window.location.pathname + '/messages')
        .then(response => response.json())
        .then(data => {
            if (data.messages && data.messages.length > 0) {
                // Only refresh if there are new messages
                const currentMessages = messageContainer.querySelectorAll('.message-item').length;
                if (data.messages.length > currentMessages) {
                    location.reload();
                }
            }
        })
        .catch(error => {
            console.error('Error refreshing messages:', error);
        });
}

function initializeQuickProductForm() {
    const form = document.getElementById('quickProductForm');
    if (form) {
        // Auto-resize textareas
        const textareas = form.querySelectorAll('textarea');
        textareas.forEach(textarea => {
            textarea.addEventListener('input', function() {
                this.style.height = 'auto';
                this.style.height = this.scrollHeight + 'px';
            });
        });
    }
}

function toggleNegotiationPanel() {
    // Clear existing content
    document.getElementById('offerProductsList').innerHTML = '';
    document.getElementById('requestProductsList').innerHTML = '';
    
    negotiationModal.show();
    
    // Load user products and populate the initial selector
    fetch('/products/user/available')
        .then(response => response.json())
        .then(data => {
            if (data.success && data.products) {
                // Add initial offer product selector
                const container = document.getElementById('offerProductsList');
                const productSelector = createProductSelector('offer');
                container.appendChild(productSelector);
                
                // Populate with products
                const select = productSelector.querySelector('select');
                populateSelect(select, data.products);
                
                // Store products for later use
                window.userProducts = data.products;
            } else {
                alert('Anda belum memiliki produk untuk ditawarkan. Silakan tambah produk terlebih dahulu.');
                negotiationModal.hide();
            }
        })
        .catch(error => {
            console.error('Error loading user products:', error);
            alert('Gagal memuat produk Anda. Coba lagi.');
        });
}

function sendQuickMessage(message) {
    const messageInput = document.querySelector('textarea[name="message"]');
    if (messageInput) {
        messageInput.value = message;
        messageInput.focus();
        // Auto-submit after a short delay
        setTimeout(() => {
            const form = document.getElementById('messageForm');
            if (form) {
                const event = new Event('submit');
                form.dispatchEvent(event);
            }
        }, 500);
    }
}

function loadUserProducts() {
    // Load user's available products for offering
    fetch('/products/user/available')
        .then(response => response.json())
        .then(data => {
            if (data.success && data.products) {
                // Populate offer products list
                updateProductsList('offerProductsList', data.products, 'offer');
                // Also populate any existing product selectors
                populateProductSelectors(data.products);
            }
        })
        .catch(error => {
            console.error('Error loading user products:', error);
        });
}

function addOfferProduct() {
    // Add product selection to offer list
    const container = document.getElementById('offerProductsList');
    const productItem = createProductSelector('offer');
    container.appendChild(productItem);
    
    // Load and populate products for the new selector
    fetch('/products/user/available')
        .then(response => response.json())
        .then(data => {
            if (data.success && data.products) {
                const select = productItem.querySelector('select');
                populateSelect(select, data.products);
            }
        })
        .catch(error => {
            console.error('Error loading products for new selector:', error);
        });
}

function addRequestProduct() {
    // Add manual product request input
    const container = document.getElementById('requestProductsList');
    const div = document.createElement('div');
    div.className = 'request-item mb-2 p-3 border rounded bg-light';
    div.innerHTML = `
        <div class="d-flex justify-content-between align-items-start mb-2">
            <div class="flex-grow-1">
                <input type="text" class="form-control form-control-sm mb-2" placeholder="Nama produk yang diminta..." required>
                <textarea class="form-control form-control-sm" rows="2" placeholder="Deskripsi detail produk yang diinginkan..."></textarea>
            </div>
            <button type="button" class="btn btn-outline-danger btn-sm ms-2" onclick="this.parentElement.parentElement.remove()">
                <i class="fas fa-trash"></i>
            </button>
        </div>
        <div class="row g-2">
            <div class="col-6">
                <input type="number" class="form-control form-control-sm" placeholder="Jumlah" min="1" value="1">
            </div>
            <div class="col-6">
                <select class="form-select form-select-sm">
                    <option value="">Kondisi yang diinginkan</option>
                    <option value="New">Baru</option>
                    <option value="Like New">Seperti Baru</option>
                    <option value="Good">Baik</option>
                    <option value="Fair">Cukup</option>
                </select>
            </div>
        </div>
    `;
    container.appendChild(div);
}

function updateProductsList(containerId, products, type) {
    const container = document.getElementById(containerId);
    if (!container) return;
    
    container.innerHTML = '';
    
    if (type === 'offer') {
        // Add initial product selector for offering
        const productSelector = createProductSelector(type);
        container.appendChild(productSelector);
        
        // Populate the selector with user's products
        const select = productSelector.querySelector('select');
        populateSelect(select, products);
    }
}

function populateProductSelectors(products) {
    // Populate all existing product selectors
    const selectors = document.querySelectorAll('#offerProductsList select, #requestProductsList select');
    selectors.forEach(select => {
        populateSelect(select, products);
    });
}

function populateSelect(select, products) {
    if (!select || !products) return;
    
    // Clear existing options except the first one
    select.innerHTML = '<option value="">Pilih produk...</option>';
    
    products.forEach(product => {
        const option = document.createElement('option');
        option.value = product.id;
        option.textContent = `${product.title} (${product.total_points} poin) - ${product.condition}`;
        option.setAttribute('data-points', product.total_points);
        select.appendChild(option);
    });
}

function createProductSelector(type) {
    const div = document.createElement('div');
    div.className = 'product-selector mb-2 p-3 border rounded';
    div.innerHTML = `
        <div class="d-flex justify-content-between align-items-center mb-2">
            <select class="form-select form-select-sm product-select">
                <option value="">Pilih produk...</option>
            </select>
            <button type="button" class="btn btn-outline-danger btn-sm" onclick="this.parentElement.parentElement.remove()">
                <i class="fas fa-trash"></i>
            </button>
        </div>
        <div class="row g-2">
            <div class="col">
                <input type="number" class="form-control form-control-sm" placeholder="Jumlah" min="1" value="1">
            </div>
            <div class="col">
                <input type="text" class="form-control form-control-sm" placeholder="Catatan (opsional)">
            </div>
        </div>
    `;
    return div;
}

function submitNegotiation() {
    const message = document.getElementById('negotiationMessage').value;
    const offerProducts = collectProducts('offerProductsList');
    const requestProducts = collectProducts('requestProductsList');
    
    const data = {
        message: message,
        message_type: 'offer',
        offered_products: offerProducts,
        requested_products: requestProducts
    };
    
    fetch(window.location.pathname + '/send_negotiation', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': document.querySelector('input[name="csrf_token"]').value
        },
        body: JSON.stringify(data)
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            location.reload(); // Refresh to show new message
        } else {
            alert('Error: ' + data.error);
        }
    });
}

function collectProducts(containerId) {
    const container = document.getElementById(containerId);
    const products = [];
    
    container.querySelectorAll('.product-selector').forEach(selector => {
        const select = selector.querySelector('select');
        const productId = select.value;
        const quantity = selector.querySelector('input[type="number"]').value;
        const noteInput = selector.querySelector('input[type="text"]');
        const note = noteInput ? noteInput.value : '';
        
        if (productId && productId !== '') {
            const selectedOption = select.options[select.selectedIndex];
            const points = selectedOption.getAttribute('data-points') || 0;
            
            products.push({
                product_id: parseInt(productId),
                quantity: parseInt(quantity) || 1,
                note: note,
                points: parseInt(points)
            });
        }
    });
    
    return products;
}

function acceptOffer(messageId) {
    if (confirm('Apakah Anda yakin menerima penawaran ini?')) {
        fetch(`/chat/offer/${messageId}/accept`, {
            method: 'POST',
            headers: {
                'X-CSRFToken': document.querySelector('input[name="csrf_token"]').value
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                location.reload();
            } else {
                alert('Error: ' + data.error);
            }
        });
    }
}

function counterOffer(messageId) {
    // Load the original offer data and pre-populate negotiation form
    toggleNegotiationPanel();
    // TODO: Pre-populate form with original offer data for counter-offer
}

function declineOffer(messageId) {
    const reason = prompt('Alasan menolak (opsional):');
    fetch(`/chat/offer/${messageId}/decline`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': document.querySelector('input[name="csrf_token"]').value
        },
        body: JSON.stringify({reason: reason})
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            location.reload();
        } else {
            alert('Error: ' + data.error);
        }
    });
}

// Auto-scroll to bottom and refresh messages
document.addEventListener('DOMContentLoaded', function() {
    scrollToBottom();
    
    // Refresh messages every 5 seconds
    setInterval(function() {
        // Auto-refresh could be implemented here
    }, 5000);
});
</script>
{% endblock %}