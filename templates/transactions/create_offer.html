{% extends "base.html" %}

{% block title %}Buat Penawaran - {{ product.title }} - BarterHub{% endblock %}

{% block content %}
<div class="container py-4">
    <!-- Header -->
    <div class="row mb-4">
        <div class="col">
            <nav aria-label="breadcrumb">
                <ol class="breadcrumb">
                    <li class="breadcrumb-item"><a href="{{ url_for('main.index') }}">Beranda</a></li>
                    <li class="breadcrumb-item"><a href="{{ url_for('products.detail', id=product.id) }}">{{ product.title[:30] }}...</a></li>
                    <li class="breadcrumb-item active">Buat Penawaran</li>
                </ol>
            </nav>
            <h2>
                <i class="fas fa-handshake text-primary me-2"></i>Buat Penawaran Barter
            </h2>
            <p class="text-muted">Pilih produk Anda untuk ditawarkan dalam pertukaran</p>
        </div>
    </div>

    <div class="row g-4">
        <!-- Product Requested -->
        <div class="col-lg-5">
            <div class="card border-0 shadow-sm">
                <div class="card-header bg-primary text-white">
                    <h5 class="mb-0">
                        <i class="fas fa-box me-2"></i>Produk yang Diminta
                    </h5>
                </div>
                <div class="card-body">
                    <div class="text-center mb-3">
                        <img src="{{ url_for('static', filename='uploads/products/' + product.get_main_image()) }}" 
                             class="img-fluid rounded" style="max-height: 200px;" alt="{{ product.title }}"
                             onerror="this.src='https://via.placeholder.com/300x200?text=No+Image'">
                    </div>
                    <h6>{{ product.title }}</h6>
                    <p class="text-muted">{{ product.description }}</p>
                    
                    <div class="row g-3 mb-3">
                        <div class="col-6">
                            <small class="text-muted">Kategori</small>
                            <div class="fw-semibold">{{ product.category.name }}</div>
                        </div>
                        <div class="col-6">
                            <small class="text-muted">Kondisi</small>
                            <div class="fw-semibold">{{ product.condition }}</div>
                        </div>
                        <div class="col-6">
                            <small class="text-muted">Penjual</small>
                            <div class="fw-semibold">{{ product.owner.full_name }}</div>
                        </div>
                        <div class="col-6">
                            <small class="text-muted">Poin</small>
                            <div class="fw-semibold text-primary">{{ product.total_points }}</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Offer Products -->
        <div class="col-lg-7">
            <div class="card border-0 shadow-sm">
                <div class="card-header bg-success text-white">
                    <h5 class="mb-0">
                        <i class="fas fa-gifts me-2"></i>Pilih Produk untuk Ditawarkan
                    </h5>
                </div>
                <div class="card-body">
                    {% if user_products %}
                    <form method="POST">
                        <!-- Suggested Product Alert -->
                        {% if suggested_product %}
                        <div class="alert alert-success border-0 shadow-sm mb-4">
                            <div class="d-flex align-items-center">
                                <i class="fas fa-magic text-success me-3 fs-4"></i>
                                <div>
                                    <h6 class="alert-heading mb-1">Produk Disarankan untuk Barter</h6>
                                    <p class="mb-0">
                                        "<strong>{{ suggested_product.title }}</strong>" sangat cocok untuk barter dengan produk ini!
                                        <span class="badge bg-success ms-2">{{ suggested_product.total_points }} Poin</span>
                                    </p>
                                </div>
                            </div>
                        </div>
                        {% endif %}

                        <div class="row g-3">
                            {% for user_product in user_products %}
                            <div class="col-md-6">
                                <div class="card border {% if suggested_product and user_product.id == suggested_product.id %}border-success shadow{% endif %}">
                                    {% if suggested_product and user_product.id == suggested_product.id %}
                                    <div class="position-absolute top-0 start-0 w-100">
                                        <div class="badge bg-success w-100 rounded-0 rounded-top">
                                            <i class="fas fa-star me-1"></i>DISARANKAN
                                        </div>
                                    </div>
                                    {% endif %}
                                    <div class="position-relative">
                                        <img src="{{ url_for('static', filename='uploads/products/' + user_product.get_main_image()) }}" 
                                             class="card-img-top" style="height: 150px; object-fit: cover; {% if suggested_product and user_product.id == suggested_product.id %}margin-top: 30px;{% endif %}" 
                                             alt="{{ user_product.title }}"
                                             onerror="this.src='https://via.placeholder.com/200x150?text=No+Image'">
                                        <div class="position-absolute top-0 end-0 m-2">
                                            <span class="badge bg-primary">{{ user_product.total_points }} Poin</span>
                                        </div>
                                    </div>
                                    <div class="card-body">
                                        <div class="form-check mb-2">
                                            <input class="form-check-input product-checkbox" type="checkbox" 
                                                   name="offered_products" value="{{ user_product.id }}" 
                                                   id="product{{ user_product.id }}" 
                                                   data-points="{{ user_product.total_points }}"
                                                   {% if suggested_product and user_product.id == suggested_product.id %}checked{% endif %}>
                                            <label class="form-check-label fw-semibold" for="product{{ user_product.id }}">
                                                {% if suggested_product and user_product.id == suggested_product.id %}
                                                <i class="fas fa-star text-warning me-1"></i>Pilih Produk Ini (Disarankan)
                                                {% else %}
                                                Pilih Produk Ini
                                                {% endif %}
                                            </label>
                                        </div>
                                        <h6 class="card-title">{{ user_product.title }}</h6>
                                        <p class="card-text text-muted small">
                                            {{ user_product.description[:60] }}...
                                        </p>
                                        <div class="d-flex justify-content-between align-items-center">
                                            <small class="text-muted">{{ user_product.condition }}</small>
                                            <small class="text-muted">{{ user_product.category.name }}</small>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            {% endfor %}
                        </div>

                        <!-- Point Summary -->
                        <div class="row mt-4">
                            <div class="col">
                                <div class="card bg-light border-0">
                                    <div class="card-body">
                                        <h6>Ringkasan Poin</h6>
                                        <div class="row g-3">
                                            <div class="col-md-4">
                                                <div class="text-center">
                                                    <div class="h4 text-primary mb-0" id="target-points">{{ product.total_points }}</div>
                                                    <small class="text-muted">Poin Target</small>
                                                </div>
                                            </div>
                                            <div class="col-md-4">
                                                <div class="text-center">
                                                    <div class="h4 text-success mb-0" id="offered-points">0</div>
                                                    <small class="text-muted">Poin Ditawarkan</small>
                                                </div>
                                            </div>
                                            <div class="col-md-4">
                                                <div class="text-center">
                                                    <div class="h4 mb-0" id="difference-points">-{{ product.total_points }}</div>
                                                    <small class="text-muted">Selisih</small>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="mt-3">
                                            <div class="progress" style="height: 10px;">
                                                <div class="progress-bar bg-success" role="progressbar" 
                                                     style="width: 0%" id="progress-bar"></div>
                                            </div>
                                            <small class="text-muted mt-1 d-block" id="balance-status">
                                                Pilih produk untuk memulai penawaran
                                            </small>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Submit Button -->
                        <div class="d-grid gap-2 mt-4">
                            <button type="submit" class="btn btn-success btn-lg" id="submit-offer" disabled>
                                <i class="fas fa-handshake me-2"></i>Kirim Penawaran
                            </button>
                            <a href="{{ url_for('products.detail', id=product.id) }}" class="btn btn-secondary">
                                <i class="fas fa-arrow-left me-1"></i>Kembali
                            </a>
                        </div>
                    </form>
                    {% else %}
                    <!-- No Products Available -->
                    <div class="text-center py-5">
                        <i class="fas fa-box-open fs-1 text-muted mb-3"></i>
                        <h5 class="text-muted">Anda belum memiliki produk</h5>
                        <p class="text-muted">Tambahkan produk terlebih dahulu untuk bisa melakukan barter.</p>
                        {% if current_user.is_seller() %}
                        <a href="{{ url_for('products.add') }}" class="btn btn-primary">
                            <i class="fas fa-plus me-1"></i>Tambah Produk
                        </a>
                        {% else %}
                        <div class="alert alert-info">
                            <i class="fas fa-info-circle me-2"></i>
                            Anda bisa menambah produk untuk transaksi barter. Produk Anda akan tersedia untuk ditukar tapi tidak dipublikasikan di halaman utama.
                        </div>
                        {% endif %}
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const checkboxes = document.querySelectorAll('.product-checkbox');
    const targetPoints = {{ product.total_points }};
    const offeredPointsEl = document.getElementById('offered-points');
    const differencePointsEl = document.getElementById('difference-points');
    const progressBar = document.getElementById('progress-bar');
    const balanceStatus = document.getElementById('balance-status');
    const submitButton = document.getElementById('submit-offer');

    function updatePointsSummary() {
        let totalOffered = 0;
        checkboxes.forEach(checkbox => {
            if (checkbox.checked) {
                totalOffered += parseInt(checkbox.dataset.points);
            }
        });

        const difference = totalOffered - targetPoints;
        const percentage = Math.min((totalOffered / targetPoints) * 100, 100);

        offeredPointsEl.textContent = totalOffered;
        differencePointsEl.textContent = difference >= 0 ? '+' + difference : difference;
        progressBar.style.width = percentage + '%';

        // Update colors based on balance
        if (difference === 0) {
            differencePointsEl.className = 'h4 text-success mb-0';
            balanceStatus.textContent = 'Penawaran seimbang - siap dikirim!';
            balanceStatus.className = 'text-success mt-1 d-block';
            submitButton.disabled = false;
        } else if (Math.abs(difference) <= targetPoints * 0.1) { // 10% tolerance
            differencePointsEl.className = 'h4 text-warning mb-0';
            balanceStatus.textContent = 'Penawaran cukup seimbang - dapat dikirim';
            balanceStatus.className = 'text-warning mt-1 d-block';
            submitButton.disabled = false;
        } else if (difference > 0) {
            differencePointsEl.className = 'h4 text-info mb-0';
            balanceStatus.textContent = 'Penawaran berlebih - masih dapat dikirim';
            balanceStatus.className = 'text-info mt-1 d-block';
            submitButton.disabled = false;
        } else {
            differencePointsEl.className = 'h4 text-danger mb-0';
            balanceStatus.textContent = 'Poin kurang - tambah produk lain';
            balanceStatus.className = 'text-danger mt-1 d-block';
            submitButton.disabled = totalOffered === 0;
        }

        if (totalOffered === 0) {
            balanceStatus.textContent = 'Pilih minimal satu produk';
            balanceStatus.className = 'text-muted mt-1 d-block';
            submitButton.disabled = true;
        }
    }

    checkboxes.forEach(checkbox => {
        checkbox.addEventListener('change', updatePointsSummary);
    });
});
</script>
{% endblock %}
