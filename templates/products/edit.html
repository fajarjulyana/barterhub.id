{% extends "base.html" %}

{% block title %}Edit Produk - BarterHub{% endblock %}

{% block content %}
<div class="container py-4">
    <!-- Header -->
    <div class="row mb-4">
        <div class="col">
            <nav aria-label="breadcrumb">
                <ol class="breadcrumb">
                    <li class="breadcrumb-item"><a href="{{ url_for('main.index') }}">Beranda</a></li>
                    <li class="breadcrumb-item"><a href="{{ url_for('products.list_products') }}">Produk</a></li>
                    <li class="breadcrumb-item"><a href="{{ url_for('products.detail', id=product.id) }}">{{ product.title[:30] }}...</a></li>
                    <li class="breadcrumb-item active">Edit</li>
                </ol>
            </nav>
            <h2>
                <i class="fas fa-edit text-warning me-2"></i>Edit Produk
            </h2>
            <p class="text-muted">Perbarui informasi produk "{{ product.title }}"</p>
        </div>
    </div>

    <div class="row">
        <div class="col-lg-8">
            <div class="card border-0 shadow-sm">
                <div class="card-body">
                    <form method="POST" enctype="multipart/form-data">
                        {{ form.hidden_tag() }}
                        
                        <!-- Basic Information -->
                        <div class="mb-4">
                            <h5 class="text-primary mb-3">
                                <i class="fas fa-info-circle me-2"></i>Informasi Dasar
                            </h5>
                            
                            <div class="form-floating mb-3">
                                {{ form.title(class="form-control" + (" is-invalid" if form.title.errors else "")) }}
                                {{ form.title.label(class="form-label") }}
                                {% if form.title.errors %}
                                    <div class="invalid-feedback">
                                        {% for error in form.title.errors %}{{ error }}{% endfor %}
                                    </div>
                                {% endif %}
                            </div>

                            <div class="form-floating mb-3">
                                {{ form.description(class="form-control" + (" is-invalid" if form.description.errors else ""), style="height: 120px") }}
                                {{ form.description.label(class="form-label") }}
                                {% if form.description.errors %}
                                    <div class="invalid-feedback">
                                        {% for error in form.description.errors %}{{ error }}{% endfor %}
                                    </div>
                                {% endif %}
                            </div>

                            <div class="row g-3">
                                <div class="col-md-6">
                                    <label class="form-label">{{ form.category_id.label.text }}</label>
                                    {{ form.category_id(class="form-select" + (" is-invalid" if form.category_id.errors else "")) }}
                                    {% if form.category_id.errors %}
                                        <div class="invalid-feedback">
                                            {% for error in form.category_id.errors %}{{ error }}{% endfor %}
                                        </div>
                                    {% endif %}
                                </div>
                                <div class="col-md-6">
                                    <label class="form-label">{{ form.condition.label.text }}</label>
                                    {{ form.condition(class="form-select" + (" is-invalid" if form.condition.errors else "")) }}
                                    {% if form.condition.errors %}
                                        <div class="invalid-feedback">
                                            {% for error in form.condition.errors %}{{ error }}{% endfor %}
                                        </div>
                                    {% endif %}
                                </div>
                            </div>

                            <div class="form-floating mb-3">
                                {{ form.desired_items(class="form-control" + (" is-invalid" if form.desired_items.errors else ""), style="height: 100px") }}
                                {{ form.desired_items.label(class="form-label") }}
                                <div class="form-text">
                                    <i class="fas fa-exchange-alt text-warning me-1"></i>
                                    Sebutkan secara detail barang apa yang Anda cari untuk ditukar dengan produk ini.
                                </div>
                                {% if form.desired_items.errors %}
                                    <div class="invalid-feedback">
                                        {% for error in form.desired_items.errors %}{{ error }}{% endfor %}
                                    </div>
                                {% endif %}
                            </div>
                        </div>

                        <!-- Current Images -->
                        {% set current_images = product.images.all() %}
                        {% if current_images %}
                        <div class="mb-4">
                            <h5 class="text-primary mb-3">
                                <i class="fas fa-images me-2"></i>Foto Saat Ini
                            </h5>
                            <div class="row g-3">
                                {% for image in current_images %}
                                <div class="col-md-3">
                                    <div class="card">
                                        <img src="{{ url_for('static', filename='uploads/products/' + image.filename) }}" 
                                             class="card-img-top" style="height: 150px; object-fit: cover;" alt="Product image">
                                        <div class="card-body p-2 text-center">
                                            {% if image.is_main %}
                                            <small class="badge bg-primary">Foto Utama</small>
                                            {% endif %}
                                        </div>
                                    </div>
                                </div>
                                {% endfor %}
                            </div>
                        </div>
                        {% endif %}

                        <!-- Add New Images -->
                        <div class="mb-4">
                            <h5 class="text-primary mb-3">
                                <i class="fas fa-plus me-2"></i>Tambah Foto Baru
                            </h5>
                            
                            <div class="mb-3">
                                <label class="form-label">{{ form.images.label.text }}</label>
                                {{ form.images(class="form-control", multiple=True, accept="image/*") }}
                                <div class="form-text">
                                    <i class="fas fa-info-circle text-info me-1"></i>
                                    Upload foto tambahan jika diperlukan. Foto lama tidak akan terhapus.
                                </div>
                            </div>
                        </div>

                        <!-- Point Calculation -->
                        <div class="mb-4">
                            <h5 class="text-primary mb-3">
                                <i class="fas fa-calculator me-2"></i>Penilaian Poin Barter
                            </h5>
                            
                            <div class="row g-3">
                                <div class="col-md-6">
                                    <label class="form-label">{{ form.utility_score.label.text }}</label>
                                    {{ form.utility_score(class="form-range", min="1", max="10", oninput="updateRangeValue(this, 'utility')") }}
                                    <div class="d-flex justify-content-between text-muted small">
                                        <span>Tidak berguna (1)</span>
                                        <span id="utility-value" class="fw-bold">{{ form.utility_score.data }}</span>
                                        <span>Sangat berguna (10)</span>
                                    </div>
                                </div>
                                
                                <div class="col-md-6">
                                    <label class="form-label">{{ form.scarcity_score.label.text }}</label>
                                    {{ form.scarcity_score(class="form-range", min="1", max="10", oninput="updateRangeValue(this, 'scarcity')") }}
                                    <div class="d-flex justify-content-between text-muted small">
                                        <span>Mudah ditemukan (1)</span>
                                        <span id="scarcity-value" class="fw-bold">{{ form.scarcity_score.data }}</span>
                                        <span>Sangat langka (10)</span>
                                    </div>
                                </div>
                                
                                <div class="col-md-6">
                                    <label class="form-label">{{ form.durability_score.label.text }}</label>
                                    {{ form.durability_score(class="form-range", min="1", max="10", oninput="updateRangeValue(this, 'durability')") }}
                                    <div class="d-flex justify-content-between text-muted small">
                                        <span>Mudah rusak (1)</span>
                                        <span id="durability-value" class="fw-bold">{{ form.durability_score.data }}</span>
                                        <span>Sangat tahan lama (10)</span>
                                    </div>
                                </div>
                                
                                <div class="col-md-6">
                                    <label class="form-label">{{ form.portability_score.label.text }}</label>
                                    {{ form.portability_score(class="form-range", min="1", max="10", oninput="updateRangeValue(this, 'portability')") }}
                                    <div class="d-flex justify-content-between text-muted small">
                                        <span>Sulit dibawa (1)</span>
                                        <span id="portability-value" class="fw-bold">{{ form.portability_score.data }}</span>
                                        <span>Mudah dibawa (10)</span>
                                    </div>
                                </div>
                                
                                <div class="col-md-6">
                                    <label class="form-label">{{ form.seasonal_score.label.text }}</label>
                                    {{ form.seasonal_score(class="form-range", min="1", max="10", oninput="updateRangeValue(this, 'seasonal')") }}
                                    <div class="d-flex justify-content-between text-muted small">
                                        <span>Tidak musiman (1)</span>
                                        <span id="seasonal-value" class="fw-bold">{{ form.seasonal_score.data }}</span>
                                        <span>Sangat musiman (10)</span>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Submit Button -->
                        <div class="d-grid gap-2">
                            {{ form.submit(class="btn btn-warning btn-lg") }}
                            <a href="{{ url_for('products.detail', id=product.id) }}" class="btn btn-secondary">
                                <i class="fas fa-arrow-left me-1"></i>Kembali ke Detail
                            </a>
                        </div>
                    </form>
                </div>
            </div>
        </div>

        <!-- Sidebar -->
        <div class="col-lg-4">
            <div class="card border-0 shadow-sm">
                <div class="card-header bg-warning text-dark">
                    <h6 class="mb-0">
                        <i class="fas fa-info-circle me-2"></i>Info Produk
                    </h6>
                </div>
                <div class="card-body">
                    <div class="mb-3">
                        <small class="text-muted">Poin Saat Ini</small>
                        <div class="h4 text-primary">{{ product.total_points }} Poin</div>
                    </div>
                    <div class="mb-3">
                        <small class="text-muted">Dipublikasi</small>
                        <div>{{ product.created_at.strftime('%d %B %Y') }}</div>
                    </div>
                    <div class="mb-3">
                        <small class="text-muted">Terakhir Diupdate</small>
                        <div>{{ product.updated_at.strftime('%d %B %Y') }}</div>
                    </div>
                    <div class="mb-0">
                        <small class="text-muted">Status</small>
                        <div>
                            {% if product.is_available %}
                            <span class="badge bg-success">Tersedia</span>
                            {% else %}
                            <span class="badge bg-secondary">Tidak Tersedia</span>
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
function updateRangeValue(range, type) {
    document.getElementById(type + '-value').textContent = range.value;
}

// Initialize range values
document.addEventListener('DOMContentLoaded', function() {
    const ranges = ['utility', 'scarcity', 'durability', 'portability', 'seasonal'];
    ranges.forEach(type => {
        const range = document.querySelector(`input[name="${type}_score"]`);
        if (range) {
            updateRangeValue(range, type);
        }
    });
});
</script>
{% endblock %}
